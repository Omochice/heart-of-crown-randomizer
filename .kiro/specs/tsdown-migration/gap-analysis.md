# Implementation Gap Analysis: tsdown-migration

## Executive Summary

This gap analysis evaluates migrating the `@heart-of-crown-randomizer/card` package from unbuild to tsdown. The current package uses unbuild with zero explicit configuration, relying entirely on package.json inference. The migration to tsdown requires creating explicit configuration for 10 entry points matching package.json exports while maintaining output format compatibility.

**Scope**: Build tool replacement for a data-only TypeScript library with no runtime dependencies
**Complexity**: Small (S) - Straightforward configuration-only change
**Risk**: Low - Well-documented tools with compatible output formats

---

## 1. Current State Investigation

### Key Assets

**Build Configuration**:
- **Location**: `packages/card/package.json`
- **Current Tool**: unbuild 3.6.1
- **Configuration**: Zero explicit config - unbuild infers everything from package.json
- **Build Script**: `"build": "unbuild"` - no arguments
- **Supporting Dependency**: vite-plugin-dts 4.5.4 (for type declarations)

**TypeScript Configuration**:
- **Location**: `packages/card/tsconfig.json`
- **Strict Mode**: Enabled (`"strict": true`)
- **Target**: ES2020
- **Module**: ESNext with bundler resolution
- **noEmit**: true (types generated by build tool)

**Package Structure**:
- **Source Directory**: `packages/card/src/`
- **Output Directory**: `dist/` (in package root)
- **Entry Points**: 10 total
  - Main: `src/index.ts` → `dist/index.mjs` + `.d.ts`
  - Basic expansion: `src/basic/index.ts` + 4 category files
  - Far Eastern Border: `src/far-eastern-border/index.ts` + 2 category files
  - Types: `src/type.ts`

**Source Files** (10 total):
```
src/index.ts                         → dist/index.mjs
src/basic/index.ts                   → dist/basic/index.mjs
src/basic/basic.ts                   → dist/basic/basic.mjs
src/basic/common.ts                  → dist/basic/common.mjs
src/basic/princess.ts                → dist/basic/princess.mjs
src/basic/rare.ts                    → dist/basic/rare.mjs
src/far-eastern-border/index.ts      → dist/far-eastern-border/index.mjs
src/far-eastern-border/common.ts     → dist/far-eastern-border/common.mjs
src/far-eastern-border/princess.ts   → dist/far-eastern-border/princess.mjs
src/type.ts                          → dist/type.mjs
```

**Package Exports**:
- 10 subpath exports defined in package.json
- All exports specify ESM format (`.mjs`) with type declarations (`.d.ts`)
- Structure mirrors source directory layout in dist/

### Conventions

**Naming**:
- Source files: lowercase with hyphens (e.g., `far-eastern-border/`)
- Output files: `.mjs` extension for ESM, `.d.ts` for types
- Package exports: subpath pattern (e.g., `./basic/common`)

**Architecture**:
- Data-only library with zero runtime dependencies
- Each source file exports named collections (e.g., `export { commons }`)
- Main index.ts re-exports expansion namespaces
- Expansion index files re-export category exports

**Build Integration**:
- Turborepo orchestrates monorepo builds
- Card package build has no dependencies
- Site package check task depends on card package build
- Build outputs tracked in turbo.json: `"outputs": ["dist/**"]`

### Integration Surfaces

**Consumers**:
- Site package (`@heart-of-crown-randomizer/site`) imports card package
- Import patterns:
  - Namespace imports: `import { Basic, FarEasternBorder } from "@heart-of-crown-randomizer/card"`
  - Type imports: `import type { CommonCard } from "@heart-of-crown-randomizer/card/type"`
  - Subpath imports: Uses expansion namespace (e.g., `Basic.commons`)

**Development Workflow**:
- Type checking: `tsc --noEmit` (separate from build)
- Code quality: Biome for linting/formatting (independent)
- Clean: `rimraf dist` (build tool agnostic)
- Monorepo: Turborepo caching based on dist/ outputs

---

## 2. Requirements Feasibility Analysis

### Technical Needs Mapping

| Requirement | Current Asset | Gap Status | Notes |
|-------------|---------------|------------|-------|
| **R1: Build Tool Replacement** | unbuild in devDeps | ✅ Direct swap | Both tools produce compatible outputs |
| **R2: ESM .mjs Output** | unbuild generates .mjs | ✅ Native support | tsdown supports multiple formats including ESM |
| **R3: Type Declarations** | vite-plugin-dts | ✅ Built-in | tsdown generates .d.ts automatically |
| **R4: Subpath Exports** | 10 package.json exports | ⚠️ Configuration needed | Requires explicit entry config in tsdown |
| **R5: Directory Structure** | Mirrors src/ in dist/ | ⚠️ Verify unbundle mode | tsdown unbundle mode preserves structure |
| **R6: Strict TypeScript** | tsconfig.json strict:true | ✅ tsconfig respected | tsdown honors existing tsconfig |
| **R7: Turborepo Integration** | turbo.json outputs | ✅ Tool agnostic | Turborepo only cares about dist/ output |
| **R8: Build Script Interface** | `pnpm build` | ✅ Drop-in replacement | Change script to `tsdown` |

### Identified Gaps

**Configuration Gap**:
- **Current**: Unbuild requires zero configuration ([unbuild](https://github.com/unjs/unbuild) infers from package.json)
- **Target**: tsdown requires explicit config file ([tsdown config](https://tsdown.dev/options/config-file))
- **Impact**: Need to create `tsdown.config.ts` with 10 entry points
- **Complexity**: Low - straightforward mapping from source files to outputs

**Dependency Removal**:
- **Current**: vite-plugin-dts 4.5.4 for type generation
- **Target**: tsdown has built-in declaration generation ([tsdown features](https://tsdown.dev/guide/))
- **Impact**: Can remove vite-plugin-dts dependency
- **Complexity**: Minimal - verify .d.ts output equivalence

**Unbundle Mode Verification**:
- **Current**: unbuild preserves directory structure automatically
- **Target**: tsdown has [unbundle mode](https://tsdown.dev/options/unbundle) to preserve module structure
- **Impact**: Need to verify unbundle mode produces identical structure
- **Complexity**: Testing required during implementation

### Research Needed

1. **tsdown unbundle mode behavior**: Confirm output structure exactly matches current dist/ layout
2. **Type declaration accuracy**: Verify tsdown-generated .d.ts files are functionally equivalent to current vite-plugin-dts output
3. **Turborepo cache compatibility**: Test that changing build tool doesn't invalidate existing cache patterns

---

## 3. Implementation Approach Options

### Option A: Direct Replacement (Recommended)

**Approach**: Replace unbuild with tsdown using explicit configuration file.

**Implementation**:
1. Create `packages/card/tsdown.config.ts` with:
   - Entry points array mapping all 10 source files
   - Format: ESM with .mjs extension
   - Enable unbundle mode to preserve directory structure
   - Output directory: dist/
2. Update `package.json`:
   - Change build script to `"build": "tsdown"`
   - Replace `unbuild` with `tsdown` in devDependencies
   - Remove `vite-plugin-dts` if tsdown declarations are equivalent
3. Test build output matches current structure

**Files Modified**:
- `packages/card/package.json` (dependencies + scripts)
- `packages/card/tsdown.config.ts` (new file)

**Compatibility Assessment**:
- ✅ No changes to package.json exports
- ✅ No changes to source code
- ✅ No changes to consumer imports
- ✅ Turborepo integration unchanged

**Trade-offs**:
- ✅ Minimal changes - only build configuration
- ✅ Leverages tsdown's [Rust-based performance](https://tsdown.dev/guide/)
- ✅ Removes vite-plugin-dts dependency
- ⚠️ Requires explicit entry point maintenance if new exports added

### Option B: Incremental Migration

**Approach**: Keep unbuild temporarily, add tsdown config, validate equivalence, then switch.

**Implementation**:
1. Add tsdown as additional devDependency
2. Create `tsdown.config.ts` with production configuration
3. Add temporary script `"build:tsdown": "tsdown"`
4. Run both builds, compare outputs
5. Once validated, remove unbuild and rename script

**Files Modified**:
- `packages/card/package.json` (both tools temporarily)
- `packages/card/tsdown.config.ts` (new file)

**Trade-offs**:
- ✅ Lower risk - can validate before committing
- ✅ Easy rollback if issues discovered
- ❌ Increased complexity during migration phase
- ❌ Temporary dependency bloat

### Option C: Not Recommended - Keep Unbuild

**Rationale for exclusion**: User explicitly requested tsdown migration, so maintaining unbuild contradicts requirements.

---

## 4. Implementation Complexity & Risk

### Effort Estimate: **S (Small - 1-3 days)**

**Justification**:
- Configuration-only change with no source code modifications
- Well-documented tools with clear migration paths
- Minimal testing required (output format validation)
- Single package in monorepo (no cross-package coordination)

**Breakdown**:
- Configuration creation: 1-2 hours (10 entry points)
- Dependency updates: 15 minutes
- Build validation: 1-2 hours (compare outputs, test imports)
- Turborepo cache testing: 1 hour
- Documentation: 30 minutes

### Risk Assessment: **Low**

**Justification**:
- Both tools are mature TypeScript bundlers with compatible output formats
- No runtime code changes - purely development tooling
- Easy rollback (single commit revert)
- Output validation can be automated (file comparison)

**Mitigations**:
- Compare dist/ output byte-for-byte before/after
- Run site package tests to verify consumer compatibility
- Keep unbuild config knowledge for quick rollback

---

## 5. Requirement-to-Asset Map

| Requirement Area | Existing Assets | Gap | Implementation Notes |
|------------------|-----------------|-----|----------------------|
| **Build Tool Replacement** | unbuild 3.6.1, build script | Configuration file | Create tsdown.config.ts with entry mapping |
| **Output Format Compatibility** | .mjs and .d.ts in dist/ | Verify unbundle mode | Test output structure matches current |
| **Subpath Exports Support** | 10 package.json exports | Explicit entries needed | Map all exports to tsdown entry array |
| **TypeScript Compatibility** | tsconfig.json with strict mode | None | tsdown respects existing tsconfig |
| **Monorepo Integration** | Turborepo outputs config | None | Tool-agnostic based on dist/ |
| **Build Script Interface** | `pnpm build` → unbuild | Script update only | Change to `tsdown` command |
| **Build Configuration** | None (inferred) | Create config file | tsdown.config.ts required |
| **Development Workflow** | Independent type-check, lint | None | Build tool doesn't interfere |

---

## 6. Recommendations for Design Phase

### Preferred Approach
**Option A: Direct Replacement** is recommended for the following reasons:
1. Minimal complexity aligns with straightforward requirements
2. Clean migration without temporary states
3. Removes unnecessary vite-plugin-dts dependency
4. Leverages tsdown's improved build performance

### Key Decisions for Design
1. **Configuration File Format**: Use TypeScript (tsdown.config.ts) for type safety
2. **Entry Point Strategy**: Explicit array of all 10 entry points for clarity
3. **Unbundle Mode**: Enable to preserve directory structure matching current output
4. **Declaration Generation**: Use built-in tsdown feature, remove vite-plugin-dts

### Research Items for Design Phase
1. **Unbundle Mode Output Structure**:
   - Document exact tsdown unbundle configuration needed
   - Verify directory structure preservation
   - Confirm .mjs extension handling

2. **Type Declaration Equivalence**:
   - Compare tsdown-generated .d.ts with current vite-plugin-dts output
   - Validate declaration file accuracy for complex types
   - Ensure declaration maps (if needed) are generated

3. **Performance Baseline**:
   - Measure current unbuild build time
   - Compare with tsdown build performance
   - Document any performance improvements

4. **Turborepo Cache Behavior**:
   - Verify outputs: ["dist/**"] still captures all artifacts
   - Test cache invalidation triggers
   - Confirm incremental builds work as expected

---

## Sources

- [tsdown Documentation](https://tsdown.dev/guide/)
- [tsdown Configuration](https://tsdown.dev/options/config-file)
- [tsdown Unbundle Mode](https://tsdown.dev/options/unbundle)
- [unbuild GitHub Repository](https://github.com/unjs/unbuild)
- [unbuild npm Package](https://www.npmjs.com/package/unbuild)

